<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒè¯•å¹¿æ’­ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: #1976D2;
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
        }

        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 200px;
            background: #e0e0e0;
            padding: 16px;
        }

        .nav-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            border: none;
            background: transparent;
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: #d0d0d0;
        }

        .nav-btn.active {
            background: #1976D2;
            color: white;
        }

        .content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #333;
        }

        /* å†»ç»“é¡¶éƒ¨å¡ç‰‡ */
        .sticky-card {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* å†»ç»“å¤´éƒ¨å®¹å™¨ */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: #f5f5f5;
            padding-bottom: 16px;
        }

        .sticky-header .card {
            margin-bottom: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #1976D2;
            background: #f0f7ff;
        }

        .upload-area.dragover {
            border-color: #1976D2;
            background: #e3f2fd;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: #1976D2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565C0;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-warning {
            background: #FF9800;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-outline {
            background: white;
            border: 1px solid #ccc;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
        }

        input, select, textarea {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1976D2;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-row input, .form-row select {
            flex: 1;
        }

        .task-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .task-item.current-task {
            border: 2px solid #1976D2;
            box-shadow: 0 0 8px rgba(25, 118, 210, 0.3);
        }

        .task-item.next-task {
            border: 2px solid #4CAF50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.3);
        }

        .task-header {
            padding: 16px;
            background: #f5f5f5;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .task-header:hover {
            background: #eeeeee;
        }

        .task-content {
            padding: 16px;
            display: none;
        }

        .task-content.expanded {
            display: block;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }

        .status-pending {
            background: #fff3e0;
            color: #e65100;
        }

        .status-done {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-current {
            background: #e3f2fd;
            color: #1565C0;
        }

        .log-container {
            background: #263238;
            color: #aed581;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            margin: 16px 0;
        }

        .hidden {
            display: none !important;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .help-text {
            color: #666;
            font-size: 12px;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ è€ƒè¯•å¹¿æ’­ç³»ç»Ÿ</h1>
        <div style="display:flex; align-items:center; gap:16px">
            <span id="currentTime" style="font-size:18px; font-family:monospace"></span>
            <span>v2.0</span>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <button class="nav-btn active" onclick="showSection('import', this)">1. å¯¼å…¥æ—¶é—´è¡¨</button>
            <button class="nav-btn" onclick="showSection('schedule', this)">2. ç¼–è¾‘æ—¶é—´è¡¨</button>
            <button class="nav-btn" onclick="showSection('plan', this)">3. å¹¿æ’­è®¡åˆ’</button>
            <button class="nav-btn" onclick="showSection('settings', this)">âš™ï¸ æ¨¡æ¿è®¾ç½®</button>

            <!-- å¹´çº§å¹¿æ’­åŒºåŸŸè®¾ç½® -->
            <div style="margin-top:20px; padding:12px; background:#d0d0d0; border-radius:8px;">
                <h4 style="margin-bottom:12px; font-size:14px; color:#333;">ğŸ“ å¹´çº§å¹¿æ’­åŒºåŸŸ</h4>
                <div id="gradeLocationsPanel" style="font-size:12px;">
                    <div style="margin-bottom:8px;">
                        <label style="display:block; margin-bottom:2px; color:#555;">ä¸€å¹´çº§</label>
                        <input type="text" id="loc-ä¸€å¹´çº§" placeholder="å¦‚ï¼šä¸€æ¥¼ä¸œ" style="width:100%; padding:4px 8px; font-size:12px;" onchange="updateGradeLocation('ä¸€å¹´çº§', this.value)">
                    </div>
                    <div style="margin-bottom:8px;">
                        <label style="display:block; margin-bottom:2px; color:#555;">äºŒå¹´çº§</label>
                        <input type="text" id="loc-äºŒå¹´çº§" placeholder="å¦‚ï¼šä¸€æ¥¼è¥¿" style="width:100%; padding:4px 8px; font-size:12px;" onchange="updateGradeLocation('äºŒå¹´çº§', this.value)">
                    </div>
                    <div style="margin-bottom:8px;">
                        <label style="display:block; margin-bottom:2px; color:#555;">ä¸‰å¹´çº§</label>
                        <input type="text" id="loc-ä¸‰å¹´çº§" placeholder="å¦‚ï¼šäºŒæ¥¼ä¸œ" style="width:100%; padding:4px 8px; font-size:12px;" onchange="updateGradeLocation('ä¸‰å¹´çº§', this.value)">
                    </div>
                    <div style="margin-bottom:8px;">
                        <label style="display:block; margin-bottom:2px; color:#555;">å››å¹´çº§</label>
                        <input type="text" id="loc-å››å¹´çº§" placeholder="å¦‚ï¼šäºŒæ¥¼è¥¿" style="width:100%; padding:4px 8px; font-size:12px;" onchange="updateGradeLocation('å››å¹´çº§', this.value)">
                    </div>
                    <div style="margin-bottom:8px;">
                        <label style="display:block; margin-bottom:2px; color:#555;">äº”å¹´çº§</label>
                        <input type="text" id="loc-äº”å¹´çº§" placeholder="å¦‚ï¼šä¸‰æ¥¼ä¸œ" style="width:100%; padding:4px 8px; font-size:12px;" onchange="updateGradeLocation('äº”å¹´çº§', this.value)">
                    </div>
                    <div style="margin-bottom:8px;">
                        <label style="display:block; margin-bottom:2px; color:#555;">å…­å¹´çº§</label>
                        <input type="text" id="loc-å…­å¹´çº§" placeholder="å¦‚ï¼šä¸‰æ¥¼è¥¿" style="width:100%; padding:4px 8px; font-size:12px;" onchange="updateGradeLocation('å…­å¹´çº§', this.value)">
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- å¯¼å…¥æ¨¡å— -->
            <div id="section-import" class="section active">
                <div class="card">
                    <h2>ğŸ“· å¯¼å…¥è€ƒè¯•æ—¶é—´è¡¨</h2>
                    <p class="help-text">æ”¯æŒï¼šä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ æˆ– ç²˜è´´å‰ªè´´æ¿å›¾ç‰‡ (Ctrl+V)</p>

                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <p>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡ æˆ– ç›´æ¥ç²˜è´´ (Ctrl+V)</p>
                        <input type="file" id="fileInput" accept="image/*" style="display:none">
                    </div>

                    <div id="imagePreview" class="hidden">
                        <img id="previewImg" class="preview-image">
                        <div>
                            <button class="btn btn-outline" onclick="clearImage()">é‡æ–°ä¸Šä¼ </button>
                            <button class="btn btn-primary" onclick="startRecognition()">å¼€å§‹è¯†åˆ«</button>
                        </div>
                    </div>

                    <div id="recognitionResult" class="hidden">
                        <h3 style="margin-top:20px">è¯†åˆ«ç»“æœï¼ˆå¯ç›´æ¥ç¼–è¾‘ï¼‰</h3>
                        <table id="resultTable">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>å¹´çº§</th>
                                    <th>ç§‘ç›®</th>
                                    <th>å¼€å§‹æ—¶é—´</th>
                                    <th>ç»“æŸæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <button class="btn btn-outline" onclick="addManualExam()">+ æ‰‹åŠ¨æ·»åŠ </button>
                        <div style="margin-top:16px; text-align:right">
                            <button class="btn btn-success" onclick="saveExams()">ç¡®è®¤å¹¶ç”Ÿæˆè®¡åˆ’</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ—¶é—´è¡¨æ¨¡å— -->
            <div id="section-schedule" class="section">
                <!-- å†»ç»“çš„å¤´éƒ¨ -->
                <div class="sticky-header">
                    <div class="card">
                        <h2>â° è€ƒè¯•æ—¶é—´è¡¨</h2>
                        <div style="margin-bottom:0">
                            <button class="btn btn-primary" onclick="addManualExam()">+ æ·»åŠ è€ƒè¯•</button>
                            <button class="btn btn-success" onclick="generatePlan()">ç”Ÿæˆå¹¿æ’­è®¡åˆ’</button>
                        </div>
                    </div>
                </div>
                <!-- å¯æ»šåŠ¨çš„å†…å®¹ -->
                <div id="examList"></div>
            </div>

            <!-- è®¡åˆ’æ¨¡å— -->
            <div id="section-plan" class="section">
                <!-- å†»ç»“çš„å¤´éƒ¨ -->
                <div class="sticky-header">
                    <div class="card">
                        <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-bottom:12px">
                            <h2 style="margin-bottom:0">ğŸ“‹ å¹¿æ’­è®¡åˆ’</h2>
                            <div style="display:flex; align-items:center; gap:12px">
                                <span id="planRunStatus"><span style="color:#4CAF50; font-weight:bold">ğŸŸ¢ è¿è¡Œä¸­</span></span>
                                <button class="btn btn-warning" id="btnPlanPause" onclick="pauseAutoRun()" style="padding:6px 12px; font-size:12px; margin:0">â¸ï¸ æš‚åœ</button>
                                <button class="btn btn-success hidden" id="btnPlanResume" onclick="resumeAutoRun()" style="padding:6px 12px; font-size:12px; margin:0">â–¶ï¸ ç»§ç»­</button>
                            </div>
                        </div>
                        <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:0">
                            <button class="btn btn-warning" onclick="addTempBroadcast()">+ ä¸´æ—¶å¹¿æ’­</button>
                            <button class="btn btn-outline" onclick="testVoice()">æµ‹è¯•è¯­éŸ³</button>
                            <button class="btn btn-success" onclick="saveAll()">ä¿å­˜æ’­æŠ¥å†…å®¹</button>
                            <button class="btn btn-primary" onclick="exportPlan()">ğŸ“„ å¯¼å‡ºè®¡åˆ’</button>
                            <button class="btn btn-outline" onclick="exportData()">ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
                            <label class="btn btn-outline" style="cursor:pointer; display:inline-block">
                                ğŸ“‚ å¯¼å…¥æ•°æ®
                                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this.files[0])">
                            </label>
                            <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤</button>
                        </div>
                    </div>                </div>
                <!-- å¯æ»šåŠ¨çš„å†…å®¹ -->
                <div id="planList"></div>

                <!-- ä»Šæ—¥ä»»åŠ¡å¡ç‰‡ -->
                <div class="card" style="margin-top:16px">
                    <div style="display:flex; align-items:center; justify-content:space-between">
                        <h3>ğŸ“… ä»Šæ—¥ä»»åŠ¡</h3>
                        <span id="todayDate" class="help-text"></span>
                    </div>
                    <div id="todayTasks" style="margin-top:12px"></div>
                </div>

                <!-- ç³»ç»Ÿæ—¥å¿—å¡ç‰‡ -->
                <div class="card" style="margin-top:16px">
                    <h3>ğŸ“ ç³»ç»Ÿæ—¥å¿—</h3>
                    <div class="log-container" id="logContainer"></div>
                </div>
            </div>

            <!-- æ¨¡æ¿è®¾ç½®æ¨¡å— -->
            <div id="section-settings" class="section">
                <div class="card">
                    <h2>âš™ï¸ å¹¿æ’­æ¨¡æ¿è®¾ç½®</h2>
                    <p class="help-text" style="margin-bottom:16px">å¯ç”¨å˜é‡ï¼š{{current_time}} å½“å‰æ—¶é—´ã€{{exam_grade}} å¹´çº§ã€{{exam_subject}} ç§‘ç›®ã€{{start_time}} å¼€å§‹æ—¶é—´ã€{{end_time}} ç»“æŸæ—¶é—´ã€{{seal_open_time}} å¯å°æ—¶é—´ã€{{paper_issue_time}} å‘å·æ—¶é—´</p>

                    <div style="margin-bottom:20px">
                        <label><strong>è€ƒåŠ¡ä¼š</strong></label>
                        <textarea id="template_staff_meeting" rows="3" style="margin-top:8px"></textarea>
                    </div>

                    <div style="margin-bottom:20px">
                        <label><strong>å…¥åœº</strong></label>
                        <textarea id="template_entry" rows="3" style="margin-top:8px"></textarea>
                    </div>

                    <div style="margin-bottom:20px">
                        <label><strong>å¯å°</strong></label>
                        <textarea id="template_seal_open" rows="3" style="margin-top:8px"></textarea>
                    </div>

                    <div style="margin-bottom:20px">
                        <label><strong>å‘å·</strong></label>
                        <textarea id="template_paper_issue" rows="3" style="margin-top:8px"></textarea>
                    </div>

                    <div style="margin-bottom:20px">
                        <label><strong>è€ƒè¯•å¼€å§‹</strong></label>
                        <textarea id="template_start" rows="3" style="margin-top:8px"></textarea>
                    </div>

                    <div style="margin-bottom:20px">
                        <label><strong>è€ƒè¯•ç»“æŸ</strong></label>
                        <textarea id="template_end" rows="3" style="margin-top:8px"></textarea>
                    </div>

                    <div style="text-align:right">
                        <button class="btn btn-outline" onclick="resetTemplates()">æ¢å¤é»˜è®¤</button>
                        <button class="btn btn-success" onclick="saveTemplates()">ä¿å­˜æ¨¡æ¿</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸´æ—¶å¹¿æ’­æ¨¡æ€æ¡† -->
    <div class="modal" id="tempModal">
        <div class="modal-content">
            <h3>æ·»åŠ ä¸´æ—¶å¹¿æ’­</h3>
            <div style="margin:16px 0">
                <label>æ—¥æœŸ</label>
                <input type="date" id="tempDate">
            </div>
            <div style="margin:16px 0">
                <label>æ—¶é—´</label>
                <input type="time" id="tempTime">
            </div>
            <div style="margin:16px 0">
                <label>æ’­æŠ¥å†…å®¹</label>
                <textarea id="tempContent" rows="4"></textarea>
            </div>
            <div style="text-align:right">
                <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-warning" onclick="playTempNow()">ç«‹å³æ’­æŠ¥</button>
                <button class="btn btn-success" onclick="addTempToPlan()">æ·»åŠ åˆ°è®¡åˆ’</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== é…ç½® ====================
        const API_KEY = 'sk-Dyp9p6pin0YCxGSslrHf1QN1xWzUjGwlXL2UjbkSZXrq8P9J';
        const API_URL = 'https://www.dmxapi.cn/v1/chat/completions';

        // ==================== æ•°æ®å­˜å‚¨ ====================
        // æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œé€šè¿‡å¯¼å‡º/å¯¼å…¥JSONæ–‡ä»¶æŒä¹…åŒ–
        let exams = [];
        let plan = [];
        let isRunning = false;
        let checkInterval = null;
        let todayTasksInterval = null; // ä»Šæ—¥ä»»åŠ¡å€’è®¡æ—¶æ›´æ–°å®šæ—¶å™¨
        let currentImage = null;
        let recognizedExams = [];
        let hasAutoScrolled = false; // æ˜¯å¦å·²ç»è‡ªåŠ¨æ»šåŠ¨è¿‡ï¼ˆé˜²æ­¢æ¯æ¬¡åˆ·æ–°éƒ½æ»šåŠ¨ï¼‰
        let expandedTaskId = null; // å½“å‰å±•å¼€çš„ä»»åŠ¡IDï¼ˆç”¨äºä¿æŒå±•å¼€çŠ¶æ€ï¼‰

        // å¹´çº§å¹¿æ’­åŒºåŸŸè®¾ç½®ï¼ˆ1-6å¹´çº§å¯¹åº”çš„å¹¿æ’­åœ°ç‚¹/åŒºåŸŸï¼‰
        let gradeLocations = {
            'ä¸€å¹´çº§': '',
            'äºŒå¹´çº§': '',
            'ä¸‰å¹´çº§': '',
            'å››å¹´çº§': '',
            'äº”å¹´çº§': '',
            'å…­å¹´çº§': ''
        };

        // é»˜è®¤å¹¿æ’­æ¨¡æ¿ - æ ¹æ®Wordæ–‡æ¡£è§„èŒƒ
        const templates = {
            staff_meeting: 'ç°åœ¨æ˜¯{{current_time}}ï¼Œè¯·å„ä½ç›‘è€ƒè€å¸ˆè¯·æ³¨æ„ï¼Œ8:30åˆ°è€ƒåŠ¡åŠå…¬å®¤ç­¾åˆ°ã€é¢†å–è¯•å·ï¼Œå·¡è§†å‘˜å’Œæ¥¼å±‚å·¡è§†å‘˜åˆ°ç›¸åº”æ¥¼å±‚è€ƒåŠ¡åŠå…¬å®¤ã€‚',
            entry: 'ç°åœ¨æ˜¯{{current_time}}ï¼Œè¯·{{exam_grade}}{{exam_subject}}ç›‘è€ƒè€å¸ˆç»„ç»‡å­¦ç”Ÿå…¥åœºï¼Œæ ¸å¯¹è€ƒè¯•ç§‘ç›®ã€‚è€ƒè¯•å°†äº{{start_time}}æ­£å¼å¼€å§‹ï¼Œå¯å°æ—¶é—´ä¸º{{seal_open_time}}ï¼Œå‘å·æ—¶é—´ä¸º{{paper_issue_time}}ï¼Œæ­£å¼å¼€è€ƒæ—¶é—´ä¸º{{start_time}}ã€‚',
            seal_open: 'ç°åœ¨æ˜¯{{current_time}}ï¼Œè¯·ç›‘è€ƒè€å¸ˆå¯å°è¯•å·è¢‹ï¼Œæ ¸å¯¹{{exam_subject}}è¯•å·ç§‘ç›®æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœ‰é—®é¢˜è¯·è”ç³»å·¡è§†å‘˜ã€‚å‘å·æ—¶é—´ä¸º{{paper_issue_time}}ã€‚',
            paper_issue: 'ç°åœ¨æ˜¯{{current_time}}ï¼Œè¯·ç›‘è€ƒè€å¸ˆå‘æ”¾ç­”é¢˜å¡ï¼Œç»„ç»‡å­¦ç”Ÿå¡«å†™ç­çº§ã€å§“åã€å­¦å·ã€‚5åˆ†é’Ÿåå¼€å§‹ç­”é¢˜ã€‚',
            start: 'ç›‘è€ƒè€å¸ˆè¯·æ³¨æ„ï¼Œç°åœ¨æ˜¯{{start_time}}ï¼Œ{{exam_grade}}{{exam_subject}}è€ƒè¯•æ­£å¼å¼€å§‹ï¼Œè¯·ç›‘è€ƒè€å¸ˆç»„ç»‡å­¦ç”Ÿå¼€å§‹ç­”é¢˜ã€‚è€ƒè¯•æ— å…³äººå‘˜è¿œç¦»è€ƒåœºï¼Œå·¡è§†å‘˜åšå¥½ç›¸å…³å·¥ä½œã€‚',
            end: 'ç›‘è€ƒè€å¸ˆã€åŒå­¦ä»¬è¯·æ³¨æ„ï¼Œç°åœ¨æ˜¯{{current_time}}ï¼Œ{{exam_grade}}{{exam_subject}}è€ƒè¯•ç»“æŸï¼Œè¯·è€ƒç”Ÿåœæ­¢ç­”é¢˜ã€‚è¯·ç›‘è€ƒè€å¸ˆæŒ‰é¡ºåºæ”¶å–è¯•å·ã€ç­”é¢˜å¡ï¼Œæ¸…ç‚¹æ— è¯¯åé€äº¤è€ƒåŠ¡åŠå…¬å®¤ã€‚è¯·åŒå­¦ä»¬æ³¨æ„ä¼‘æ¯ï¼Œå‡†å¤‡ä¸‹åœºè€ƒè¯•ã€‚',
            temp: ''
        };

        const taskTypeNames = {
            staff_meeting: 'è€ƒåŠ¡ä¼š',
            entry: 'å…¥åœº',
            seal_open: 'å¯å°',
            paper_issue: 'å‘å·',
            start: 'è€ƒè¯•å¼€å§‹',
            end: 'è€ƒè¯•ç»“æŸ',
            temp: 'ä¸´æ—¶å¹¿æ’­'
        };

        // é»˜è®¤æ¨¡æ¿ï¼ˆç”¨äºæ¢å¤é»˜è®¤ï¼‰- æ ¹æ®Wordæ–‡æ¡£è§„èŒƒ
        const defaultTemplates = {
            staff_meeting: 'ç°åœ¨æ˜¯{{current_time}}ï¼Œè¯·å„ä½ç›‘è€ƒè€å¸ˆè¯·æ³¨æ„ï¼Œ8:30åˆ°è€ƒåŠ¡åŠå…¬å®¤ç­¾åˆ°ã€é¢†å–è¯•å·ï¼Œå·¡è§†å‘˜å’Œæ¥¼å±‚å·¡è§†å‘˜åˆ°ç›¸åº”æ¥¼å±‚è€ƒåŠ¡åŠå…¬å®¤ã€‚',
            entry: 'ç°åœ¨æ˜¯{{current_time}}ï¼Œè¯·{{exam_grade}}{{exam_subject}}ç›‘è€ƒè€å¸ˆç»„ç»‡å­¦ç”Ÿå…¥åœºï¼Œæ ¸å¯¹è€ƒè¯•ç§‘ç›®ã€‚è€ƒè¯•å°†äº{{start_time}}æ­£å¼å¼€å§‹ï¼Œå¯å°æ—¶é—´ä¸º{{seal_open_time}}ï¼Œå‘å·æ—¶é—´ä¸º{{paper_issue_time}}ï¼Œæ­£å¼å¼€è€ƒæ—¶é—´ä¸º{{start_time}}ã€‚',
            seal_open: 'ç°åœ¨æ˜¯{{current_time}}ï¼Œè¯·ç›‘è€ƒè€å¸ˆå¯å°è¯•å·è¢‹ï¼Œæ ¸å¯¹{{exam_subject}}è¯•å·ç§‘ç›®æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœ‰é—®é¢˜è¯·è”ç³»å·¡è§†å‘˜ã€‚å‘å·æ—¶é—´ä¸º{{paper_issue_time}}ã€‚',
            paper_issue: 'ç°åœ¨æ˜¯{{current_time}}ï¼Œè¯·ç›‘è€ƒè€å¸ˆå‘æ”¾ç­”é¢˜å¡ï¼Œç»„ç»‡å­¦ç”Ÿå¡«å†™ç­çº§ã€å§“åã€å­¦å·ã€‚5åˆ†é’Ÿåå¼€å§‹ç­”é¢˜ã€‚',
            start: 'ç›‘è€ƒè€å¸ˆè¯·æ³¨æ„ï¼Œç°åœ¨æ˜¯{{start_time}}ï¼Œ{{exam_grade}}{{exam_subject}}è€ƒè¯•æ­£å¼å¼€å§‹ï¼Œè¯·ç›‘è€ƒè€å¸ˆç»„ç»‡å­¦ç”Ÿå¼€å§‹ç­”é¢˜ã€‚è€ƒè¯•æ— å…³äººå‘˜è¿œç¦»è€ƒåœºï¼Œå·¡è§†å‘˜åšå¥½ç›¸å…³å·¥ä½œã€‚',
            end: 'ç›‘è€ƒè€å¸ˆã€åŒå­¦ä»¬è¯·æ³¨æ„ï¼Œç°åœ¨æ˜¯{{current_time}}ï¼Œ{{exam_grade}}{{exam_subject}}è€ƒè¯•ç»“æŸï¼Œè¯·è€ƒç”Ÿåœæ­¢ç­”é¢˜ã€‚è¯·ç›‘è€ƒè€å¸ˆæŒ‰é¡ºåºæ”¶å–è¯•å·ã€ç­”é¢˜å¡ï¼Œæ¸…ç‚¹æ— è¯¯åé€äº¤è€ƒåŠ¡åŠå…¬å®¤ã€‚è¯·åŒå­¦ä»¬æ³¨æ„ä¼‘æ¯ï¼Œå‡†å¤‡ä¸‹åœºè€ƒè¯•ã€‚'
        };

        // å½“å‰ä½¿ç”¨çš„æ¨¡æ¿ï¼ˆå¯ä»¥è¢«ä¿®æ”¹ï¼‰
        let customTemplates = null;

        // ==================== LocalStorage æ•°æ®æŒä¹…åŒ– ====================
        // ä¿å­˜æ•°æ®åˆ° LocalStorage
        function saveToLocalStorage() {
            const data = {
                exams: exams,
                plan: plan,
                templates: customTemplates,
                gradeLocations: gradeLocations,
                saveTime: new Date().toISOString()
            };
            localStorage.setItem('examBroadcastData', JSON.stringify(data));
        }

        // ä» LocalStorage åŠ è½½æ•°æ®
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('examBroadcastData');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.exams) exams = data.exams;
                    if (data.plan) plan = data.plan;
                    if (data.templates) {
                        customTemplates = data.templates;
                        Object.assign(templates, customTemplates);
                    }
                    if (data.gradeLocations) {
                        gradeLocations = data.gradeLocations;
                    }
                    log('å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®: ' + exams.length + 'åœºè€ƒè¯•, ' + plan.length + 'ä¸ªä»»åŠ¡');
                    return true;
                }
            } catch (e) {
                console.error('åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥:', e);
            }
            return false;
        }

        // æ¸…é™¤æœ¬åœ°æ•°æ®
        function clearLocalStorage() {
            localStorage.removeItem('examBroadcastData');
        }

        // åŠ è½½æ¨¡æ¿åˆ°è®¾ç½®é¡µé¢
        function loadTemplates() {
            const currentTemplates = customTemplates || templates;
            document.getElementById('template_staff_meeting').value = currentTemplates.staff_meeting;
            document.getElementById('template_entry').value = currentTemplates.entry;
            document.getElementById('template_seal_open').value = currentTemplates.seal_open;
            document.getElementById('template_paper_issue').value = currentTemplates.paper_issue;
            document.getElementById('template_start').value = currentTemplates.start;
            document.getElementById('template_end').value = currentTemplates.end;
        }

        // ä¿å­˜æ¨¡æ¿
        function saveTemplates() {
            customTemplates = {
                staff_meeting: document.getElementById('template_staff_meeting').value,
                entry: document.getElementById('template_entry').value,
                seal_open: document.getElementById('template_seal_open').value,
                paper_issue: document.getElementById('template_paper_issue').value,
                start: document.getElementById('template_start').value,
                end: document.getElementById('template_end').value
            };

            // æ›´æ–°å…¨å±€ templates å¯¹è±¡
            Object.assign(templates, customTemplates);

            // å¦‚æœæœ‰è€ƒè¯•è®¡åˆ’ï¼Œè¯¢é—®æ˜¯å¦é‡æ–°ç”Ÿæˆ
            if (exams.length > 0) {
                if (confirm('æ¨¡æ¿å·²ä¿å­˜ã€‚æ˜¯å¦ä½¿ç”¨æ–°æ¨¡æ¿é‡æ–°ç”Ÿæˆå¹¿æ’­è®¡åˆ’ï¼Ÿ')) {
                    generatePlan();
                }
            } else {
                alert('æ¨¡æ¿å·²ä¿å­˜ï¼');
            }

            log('å¹¿æ’­æ¨¡æ¿å·²ä¿å­˜');

            // ä¿å­˜åˆ° LocalStorage
            saveToLocalStorage();
        }

        // æ¢å¤é»˜è®¤æ¨¡æ¿
        function resetTemplates() {
            if (confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤æ¨¡æ¿å—ï¼Ÿæ‰€æœ‰è‡ªå®šä¹‰ä¿®æ”¹å°†ä¸¢å¤±ã€‚')) {
                customTemplates = null;
                Object.assign(templates, defaultTemplates);
                loadTemplates();
                log('å·²æ¢å¤é»˜è®¤æ¨¡æ¿');
            }
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function log(msg) {
            const container = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();
            container.innerHTML += `[${time}] ${msg}<br>`;
            container.scrollTop = container.scrollHeight;
        }

        // æ›´æ–°å¹´çº§åœ°ç‚¹
        function updateGradeLocation(grade, location) {
            gradeLocations[grade] = location;
            saveToLocalStorage();
            log(`æ›´æ–°${grade}å¹¿æ’­åŒºåŸŸ: ${location || 'æœªè®¾ç½®'}`);
        }

        // åŠ è½½å¹´çº§åœ°ç‚¹åˆ°ä¾§è¾¹æ 
        function loadGradeLocations() {
            Object.keys(gradeLocations).forEach(grade => {
                const input = document.getElementById(`loc-${grade}`);
                if (input) {
                    input.value = gradeLocations[grade] || '';
                }
            });
        }

        // è·å–å¹´çº§çš„å¹¿æ’­åŒºåŸŸï¼ˆç”¨äºæ’­æŠ¥å†…å®¹ï¼‰
        function getGradeLocation(grade) {
            // æ”¯æŒå¤šç§å¹´çº§æ ¼å¼åŒ¹é…
            for (let key in gradeLocations) {
                if (grade.includes(key) || key.includes(grade)) {
                    return gradeLocations[key];
                }
            }
            return '';
        }

        // æ›´æ–°å³ä¸Šè§’æ—¶é—´æ˜¾ç¤º
        function updateCurrentTime() {
            const timeEl = document.getElementById('currentTime');
            if (timeEl) {
                const now = new Date();
                const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
                timeEl.textContent = timeStr;
            }
        }

        // å¯¼å‡ºæ•°æ®åˆ°JSONæ–‡ä»¶
        function exportData() {
            const data = {
                exams: exams,
                plan: plan,
                templates: customTemplates, // å¯¼å‡ºè‡ªå®šä¹‰æ¨¡æ¿
                gradeLocations: gradeLocations, // å¯¼å‡ºå¹´çº§å¹¿æ’­åŒºåŸŸ
                exportTime: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'è€ƒè¯•å¹¿æ’­æ•°æ®_' + new Date().toISOString().slice(0,10) + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            log('æ•°æ®å·²å¯¼å‡º');
        }

        // ä»JSONæ–‡ä»¶å¯¼å…¥æ•°æ®
        function importData(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.exams) exams = data.exams;
                    if (data.plan) plan = data.plan;
                    // å¯¼å…¥æ¨¡æ¿è®¾ç½®
                    if (data.templates) {
                        customTemplates = data.templates;
                        Object.assign(templates, customTemplates);
                    }
                    // å¯¼å…¥å¹´çº§å¹¿æ’­åŒºåŸŸ
                    if (data.gradeLocations) {
                        gradeLocations = data.gradeLocations;
                        loadGradeLocations(); // æ›´æ–°ä¾§è¾¹æ æ˜¾ç¤º
                    }
                    // ä¿å­˜åˆ° LocalStorage
                    saveToLocalStorage();
                    renderExamList();
                    renderPlanList();
                    log('æ•°æ®å·²å¯¼å…¥: ' + (exams.length || 0) + 'åœºè€ƒè¯•, ' + (plan.length || 0) + 'ä¸ªå¹¿æ’­ä»»åŠ¡');
                    alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                } catch (err) {
                    alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤ï¼š\n- æ‰€æœ‰è€ƒè¯•ä¿¡æ¯\n- æ‰€æœ‰å¹¿æ’­è®¡åˆ’\n- è‡ªå®šä¹‰æ¨¡æ¿\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                exams = [];
                plan = [];
                customTemplates = null;
                Object.assign(templates, defaultTemplates);
                clearLocalStorage();
                renderExamList();
                renderPlanList();
                log('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤');
                alert('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤');
            }
        }

        // ä¿å­˜æ•°æ®ï¼ˆåˆ° LocalStorageï¼‰
        function saveData() {
            saveToLocalStorage();
        }

        function timeSubtract(timeStr, minutes) {
            const [h, m] = timeStr.split(':').map(Number);
            const date = new Date(2000, 0, 1, h, m - minutes);
            return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
        }

        function showSection(name, clickedBtn = null) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('section-' + name).classList.add('active');

            // å¦‚æœæ²¡æœ‰ä¼ å…¥æŒ‰é’®ï¼Œæ‰¾åˆ°å¯¹åº”çš„å¯¼èˆªæŒ‰é’®
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            } else {
                const navBtns = document.querySelectorAll('.nav-btn');
                const index = ['import', 'schedule', 'plan', 'settings'].indexOf(name);
                if (index >= 0 && navBtns[index]) {
                    navBtns[index].classList.add('active');
                }
            }

            // ä¿å­˜å½“å‰tabåˆ°localStorage
            localStorage.setItem('examBroadcastCurrentTab', name);

            if (name === 'schedule') renderExamList();
            if (name === 'plan') {
                // é‡ç½®è‡ªåŠ¨æ»šåŠ¨æ ‡å¿—ï¼ˆæ¯æ¬¡è¿›å…¥å¹¿æ’­è®¡åˆ’é¡µé¢æ—¶å…è®¸æ»šåŠ¨ä¸€æ¬¡ï¼‰
                hasAutoScrolled = false;
                expandedTaskId = null;
                // é¦–æ¬¡æ¸²æŸ“æ—¶å…è®¸è‡ªåŠ¨æ»šåŠ¨
                renderPlanList(true);
                renderTodayTasks();
                // å¯åŠ¨å€’è®¡æ—¶è‡ªåŠ¨æ›´æ–°ï¼ˆæ¯ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
                if (todayTasksInterval) clearInterval(todayTasksInterval);
                todayTasksInterval = setInterval(() => {
                    renderTodayTasks();
                    // åªæ›´æ–°å€’è®¡æ—¶æ–‡æœ¬ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨ï¼ˆé¿å…æŠ˜å å·²å±•å¼€çš„ä»»åŠ¡ï¼‰
                    updatePlanCountdown();
                }, 1000);
            } else {
                // ç¦»å¼€å¹¿æ’­è®¡åˆ’é¡µé¢æ—¶åœæ­¢å€’è®¡æ—¶æ›´æ–°
                if (todayTasksInterval) {
                    clearInterval(todayTasksInterval);
                    todayTasksInterval = null;
                }
            }
            if (name === 'settings') loadTemplates();
        }

        // ==================== å›¾ç‰‡å¤„ç† ====================
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                handleImage(e.target.files[0]);
            }
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files[0]) {
                handleImage(e.dataTransfer.files[0]);
            }
        });

        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    handleImage(item.getAsFile());
                    break;
                }
            }
        });

        function handleImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImage = e.target.result;
                document.getElementById('previewImg').src = currentImage;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('uploadArea').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            currentImage = null;
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('recognitionResult').classList.add('hidden');
            document.getElementById('fileInput').value = '';
        }

        // ==================== AIè¯†åˆ« ====================
        async function startRecognition() {
            if (!currentImage) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }

            const btn = event.target;
            btn.textContent = 'è¯†åˆ«ä¸­...';
            btn.disabled = true;

            try {
                const base64Image = currentImage.split(',')[1];

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'GLM-4.1V-Thinking-Flash',
                        messages: [{
                            role: 'user',
                            content: [
                                { type: 'text', text: 'è¯·è¯†åˆ«è¿™å¼ è€ƒè¯•æ—¶é—´è¡¨å›¾ç‰‡ï¼Œæå–æ‰€æœ‰è€ƒè¯•ä¿¡æ¯ï¼ˆæ—¥æœŸã€å¹´çº§ã€ç§‘ç›®ã€å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ï¼‰ï¼ŒæŒ‰JSONæ ¼å¼è¿”å›ï¼š{"exams":[{"date":"YYYY-MM-DD","grade":"å¹´çº§","subject":"ç§‘ç›®","start_time":"HH:MM","end_time":"HH:MM"}]}' },
                                { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${base64Image}` } }
                            ]
                        }],
                        stream: false,
                        temperature: 0.3
                    })
                });

                const data = await response.json();
                const content = data.choices[0].message.content;

                // è§£æJSON
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const result = JSON.parse(jsonMatch[0]);
                    recognizedExams = result.exams || [];

                    // ä¿®å¤æ—¥æœŸæ ¼å¼ï¼ˆç»Ÿä¸€è½¬æ¢ä¸ºYYYY-MM-DDï¼‰
                    const currentYear = new Date().getFullYear();
                    recognizedExams.forEach(exam => {
                        if (exam.date) {
                            // å¤„ç†å„ç§åˆ†éš”ç¬¦ï¼ˆ/ã€\ã€.ç­‰ï¼‰
                            exam.date = exam.date.replace(/[\\\/\.]/g, '-');
                            // ç¡®ä¿æ˜¯æ ‡å‡†æ ¼å¼
                            const parts = exam.date.split('-');
                            if (parts.length === 3) {
                                let year = parts[0];
                                let month = parts[1];
                                let day = parts[2];

                                // å¦‚æœå¹´ä»½æ˜¯ä¸¤ä½æ•°ï¼Œè¡¥å…¨ä¸ºå››ä½æ•°
                                if (year.length <= 2) {
                                    year = year.padStart(4, '20');
                                }

                                // å¦‚æœå¹´ä»½æ—©äºå½“å‰å¹´ä»½ï¼ˆå›¾ç‰‡å¯èƒ½æ˜¯æ—§çš„ï¼Œä½†è€ƒè¯•æ˜¯ä»Šå¹´ï¼‰ï¼Œä½¿ç”¨å½“å‰å¹´ä»½
                                // æˆ–è€…å¹´ä»½æ˜æ˜¾ä¸åˆç†ï¼ˆå°äº2000æˆ–å¤§äº2099ï¼‰ï¼Œä¹Ÿä½¿ç”¨å½“å¹´
                                const yearNum = parseInt(year);
                                if (yearNum < currentYear || yearNum < 2000 || yearNum > 2099) {
                                    year = String(currentYear);
                                }

                                month = month.padStart(2, '0');
                                day = day.padStart(2, '0');
                                exam.date = `${year}-${month}-${day}`;
                            } else if (parts.length === 2) {
                                // åªæœ‰æœˆ-æ—¥ï¼Œæ²¡æœ‰å¹´ä»½ï¼Œä½¿ç”¨å½“å¹´
                                const month = parts[0].padStart(2, '0');
                                const day = parts[1].padStart(2, '0');
                                exam.date = `${currentYear}-${month}-${day}`;
                            }
                        }
                        // ä¿®å¤å¹´çº§å’Œç§‘ç›®ä¸­çš„ä¹±ç ï¼ˆå¦‚æœAPIè¿”å›ç¼–ç æœ‰é—®é¢˜ï¼‰
                        if (exam.grade) exam.grade = exam.grade.trim();
                        if (exam.subject) exam.subject = exam.subject.trim();
                    });

                    showRecognitionResult();
                    log('å›¾ç‰‡è¯†åˆ«å®Œæˆï¼Œå…±è¯†åˆ« ' + recognizedExams.length + ' åœºè€ƒè¯•');
                }
            } catch (error) {
                alert('è¯†åˆ«å¤±è´¥: ' + error.message);
                log('è¯†åˆ«å¤±è´¥: ' + error.message);
            } finally {
                btn.textContent = 'å¼€å§‹è¯†åˆ«';
                btn.disabled = false;
            }
        }

        function showRecognitionResult() {
            const tbody = document.querySelector('#resultTable tbody');
            tbody.innerHTML = '';

            recognizedExams.forEach((exam, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="date" value="${exam.date || ''}" onchange="recognizedExams[${index}].date=this.value"></td>
                    <td><input type="text" value="${exam.grade || ''}" onchange="recognizedExams[${index}].grade=this.value"></td>
                    <td><input type="text" value="${exam.subject || ''}" onchange="recognizedExams[${index}].subject=this.value"></td>
                    <td><input type="time" value="${exam.start_time || ''}" onchange="recognizedExams[${index}].start_time=this.value"></td>
                    <td><input type="time" value="${exam.end_time || ''}" onchange="recognizedExams[${index}].end_time=this.value"></td>
                    <td><button class="btn btn-danger" onclick="recognizedExams.splice(${index},1);showRecognitionResult()">åˆ é™¤</button></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('recognitionResult').classList.remove('hidden');
        }

        function saveExams() {
            exams = [...recognizedExams];
            saveData();
            generatePlan();
            showSection('schedule');
            log('è€ƒè¯•æ—¶é—´è¡¨å·²ä¿å­˜');
        }

        // ==================== æ—¶é—´è¡¨ç®¡ç† ====================
        function renderExamList() {
            const container = document.getElementById('examList');
            if (exams.length === 0) {
                container.innerHTML = '<p style="color:#999">æš‚æ— è€ƒè¯•æ•°æ®</p>';
                return;
            }

            // æŒ‰æ—¥æœŸåˆ†ç»„
            const byDate = {};
            exams.forEach(e => {
                if (!byDate[e.date]) byDate[e.date] = [];
                byDate[e.date].push(e);
            });

            let html = '';
            Object.keys(byDate).sort().forEach(date => {
                html += `<h4 style="margin:16px 0 8px">ğŸ“… ${date}</h4>`;
                html += '<table><thead><tr><th>å¹´çº§</th><th>ç§‘ç›®</th><th>æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';
                byDate[date].forEach((exam, idx) => {
                    const globalIdx = exams.indexOf(exam);
                    html += `<tr>
                        <td>${exam.grade}</td>
                        <td>${exam.subject}</td>
                        <td>${exam.start_time} - ${exam.end_time}</td>
                        <td><button class="btn btn-danger" onclick="deleteExam(${globalIdx})">åˆ é™¤</button></td>
                    </tr>`;
                });
                html += '</tbody></table>';
            });
            container.innerHTML = html;
        }

        function addManualExam() {
            const date = prompt('æ—¥æœŸ (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            if (!date) return;
            const grade = prompt('å¹´çº§:');
            if (!grade) return;
            const subject = prompt('ç§‘ç›®:');
            if (!subject) return;
            const start = prompt('å¼€å§‹æ—¶é—´ (HH:MM):', '09:00');
            if (!start) return;
            const end = prompt('ç»“æŸæ—¶é—´ (HH:MM):', '10:00');
            if (!end) return;

            exams.push({ date, grade, subject, start_time: start, end_time: end });
            saveData();
            renderExamList();
            log('æ‰‹åŠ¨æ·»åŠ è€ƒè¯•: ' + grade + subject);
        }

        function deleteExam(index) {
            if (confirm('ç¡®å®šåˆ é™¤è¿™åœºè€ƒè¯•å—ï¼Ÿ')) {
                exams.splice(index, 1);
                saveData();
                renderExamList();
            }
        }

        // ==================== å¹¿æ’­è®¡åˆ’ç”Ÿæˆ ====================
        function generatePlan() {
            plan = [];

            // æŒ‰æ—¥æœŸåˆ†ç»„
            const byDate = {};
            exams.forEach(e => {
                if (!byDate[e.date]) byDate[e.date] = [];
                byDate[e.date].push(e);
            });

            Object.keys(byDate).forEach(date => {
                const dayExams = byDate[date].sort((a, b) => a.start_time.localeCompare(b.start_time));

                // 1. æ·»åŠ è€ƒåŠ¡ä¼šï¼ˆæ¯å¤©æ—©ä¸Š8:15ï¼Œæ¯ä¸ªæ—¥æœŸåªåŠ ä¸€æ¬¡ï¼‰
                plan.push(createTask(date, dayExams[0], 'staff_meeting', '08:15'));

                // 2. æ”¶é›†åŒä¸€å¤©åŒä¸€æ—¶é—´çš„ä»»åŠ¡ï¼Œåˆå¹¶æ’­æŠ¥
                const timeTasks = {}; // key: "HH:MM", value: [{exam, type}]

                dayExams.forEach(exam => {
                    // å…¥åœº
                    const entryTime = timeSubtract(exam.start_time, 15);
                    if (!timeTasks[entryTime]) timeTasks[entryTime] = [];
                    timeTasks[entryTime].push({ exam, type: 'entry' });

                    // å¯å°
                    const sealTime = timeSubtract(exam.start_time, 10);
                    if (!timeTasks[sealTime]) timeTasks[sealTime] = [];
                    timeTasks[sealTime].push({ exam, type: 'seal_open' });

                    // å‘å·
                    const paperTime = timeSubtract(exam.start_time, 5);
                    if (!timeTasks[paperTime]) timeTasks[paperTime] = [];
                    timeTasks[paperTime].push({ exam, type: 'paper_issue' });

                    // è€ƒè¯•å¼€å§‹
                    if (!timeTasks[exam.start_time]) timeTasks[exam.start_time] = [];
                    timeTasks[exam.start_time].push({ exam, type: 'start' });

                    // è€ƒè¯•ç»“æŸ
                    if (!timeTasks[exam.end_time]) timeTasks[exam.end_time] = [];
                    timeTasks[exam.end_time].push({ exam, type: 'end' });
                });

                // 3. æŒ‰æ—¶é—´é¡ºåºå¤„ç†ä»»åŠ¡ï¼Œåˆå¹¶åŒä¸€æ—¶é—´ç‚¹çš„
                Object.keys(timeTasks).sort().forEach(time => {
                    const tasks = timeTasks[time];
                    // æŒ‰ç±»å‹åˆ†ç»„
                    const byType = {};
                    tasks.forEach(t => {
                        if (!byType[t.type]) byType[t.type] = [];
                        byType[t.type].push(t.exam);
                    });

                    // ä¸ºæ¯ç§ç±»å‹åˆ›å»ºä»»åŠ¡ï¼ˆå¦‚æœåŒä¸€æ—¶é—´æœ‰å¤šä¸ªè€ƒè¯•ï¼Œåˆå¹¶æ’­æŠ¥å†…å®¹ï¼‰
                    Object.keys(byType).forEach(type => {
                        const examsList = byType[type];
                        plan.push(createMergedTask(date, examsList, type, time));
                    });
                });
            });

            // æŒ‰æ—¥æœŸæ—¶é—´æ’åº
            plan.sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));

            saveData();
            renderPlanList();
            log('å¹¿æ’­è®¡åˆ’å·²ç”Ÿæˆï¼Œå…± ' + plan.length + ' ä¸ªä»»åŠ¡');
            alert('å¹¿æ’­è®¡åˆ’å·²ç”Ÿæˆï¼å…± ' + plan.length + ' ä¸ªä»»åŠ¡');
        }

        function createTask(date, exam, type, time) {
            return createMergedTask(date, [exam], type, time);
        }

        function createMergedTask(date, examsList, type, time) {
            const sealOpen = timeSubtract(examsList[0].start_time, 10);
            const paperIssue = timeSubtract(examsList[0].start_time, 5);

            // ç”Ÿæˆåˆå¹¶çš„æ’­æŠ¥å†…å®¹
            let content = '';
            if (examsList.length === 1) {
                // å•ä¸ªè€ƒè¯•
                const exam = examsList[0];
                content = templates[type]
                    .replace(/\{\{current_time\}\}/g, time)
                    .replace(/\{\{exam_subject\}\}/g, exam.subject)
                    .replace(/\{\{exam_grade\}\}/g, exam.grade)
                    .replace(/\{\{start_time\}\}/g, exam.start_time)
                    .replace(/\{\{end_time\}\}/g, exam.end_time)
                    .replace(/\{\{seal_open_time\}\}/g, sealOpen)
                    .replace(/\{\{paper_issue_time\}\}/g, paperIssue);
            } else {
                // å¤šä¸ªè€ƒè¯•åˆå¹¶æ’­æŠ¥
                const examDesc = examsList.map(e => e.grade + e.subject).join('ã€');
                content = templates[type]
                    .replace(/\{\{current_time\}\}/g, time)
                    .replace(/\{\{exam_subject\}\}/g, examsList.map(e => e.subject).join('ã€'))
                    .replace(/\{\{exam_grade\}\}/g, examsList.map(e => e.grade).join('ã€'))
                    .replace(/\{\{start_time\}\}/g, examsList[0].start_time)
                    .replace(/\{\{end_time\}\}/g, examsList[0].end_time)
                    .replace(/\{\{seal_open_time\}\}/g, sealOpen)
                    .replace(/\{\{paper_issue_time\}\}/g, paperIssue);
                // æ·»åŠ è¯´æ˜æ˜¯å¤šä¸ªè€ƒè¯•
                if (type === 'entry') {
                    content = `ç°åœ¨æ˜¯${time}ï¼Œè¯·${examDesc}ç›‘è€ƒè€å¸ˆç»„ç»‡å­¦ç”Ÿå…¥åœºã€‚è€ƒè¯•å°†äº${examsList[0].start_time}æ­£å¼å¼€å§‹ã€‚`;
                } else if (type === 'seal_open') {
                    content = `ç°åœ¨æ˜¯${time}ï¼Œè¯·ç›‘è€ƒè€å¸ˆå¯å°è¯•å·è¢‹ï¼Œæ ¸å¯¹è¯•å·ç§‘ç›®æ˜¯å¦æ­£ç¡®ã€‚ä»Šæ—¥è€ƒè¯•ï¼š${examDesc}ã€‚`;
                } else if (type === 'paper_issue') {
                    content = `ç°åœ¨æ˜¯${time}ï¼Œè¯·ç›‘è€ƒè€å¸ˆå‘æ”¾ç­”é¢˜å¡ï¼Œç»„ç»‡å­¦ç”Ÿå¡«å†™ç­çº§ã€å§“åã€å­¦å·ã€‚`;
                } else if (type === 'start') {
                    content = `${time}ï¼Œ${examDesc}è€ƒè¯•æ­£å¼å¼€å§‹ï¼Œè¯·è€ƒç”Ÿå¼€å§‹ç­”é¢˜ã€‚`;
                } else if (type === 'end') {
                    content = `${time}ï¼Œ${examDesc}è€ƒè¯•ç»“æŸï¼Œè¯·è€ƒç”Ÿåœæ­¢ç­”é¢˜ã€‚`;
                }
            }

            // ç”Ÿæˆæ˜¾ç¤ºçš„è€ƒè¯•åç§°ï¼ˆé¿å…å¹´çº§é‡å¤ï¼‰
            // å¦‚æœæ‰€æœ‰è€ƒè¯•éƒ½æ˜¯åŒä¸€å¹´çº§ï¼Œæ˜¾ç¤ºä¸ºï¼šé«˜ä¸€ï¼ˆæ•°å­¦ã€è‹±è¯­ï¼‰
            // å¦‚æœå¹´çº§ä¸åŒï¼Œæ˜¾ç¤ºä¸ºï¼šé«˜ä¸€æ•°å­¦ã€é«˜äºŒç‰©ç†
            const grades = examsList.map(e => e.grade);
            const uniqueGrades = [...new Set(grades)];
            let examDisplay;
            if (uniqueGrades.length === 1) {
                // åŒä¸€å¹´çº§
                examDisplay = uniqueGrades[0] + 'ï¼ˆ' + examsList.map(e => e.subject).join('ã€') + 'ï¼‰';
            } else {
                // ä¸åŒå¹´çº§
                examDisplay = examsList.map(e => e.grade + e.subject).join('ã€');
            }

            return {
                id: Date.now() + Math.random(),
                date,
                time,
                type,
                exam_grade: uniqueGrades.join('ã€'),
                exam_subject: examsList.map(e => e.subject).join('ã€'),
                exam_display: examDisplay, // ç”¨äºæ˜¾ç¤ºçš„åç§°
                content,
                done: false,
                _exams: examsList // å†…éƒ¨ä¿å­˜åŸå§‹è€ƒè¯•åˆ—è¡¨
            };
        }

        function renderPlanList(shouldAutoScroll = false) {
            const container = document.getElementById('planList');
            if (plan.length === 0) {
                container.innerHTML = '<p style="color:#999">æš‚æ— å¹¿æ’­è®¡åˆ’ï¼Œè¯·å…ˆç”Ÿæˆ</p>';
                return;
            }

            // è®°å½•å½“å‰å±•å¼€çš„ä»»åŠ¡IDï¼ˆç”¨äºé‡æ–°æ¸²æŸ“åä¿æŒå±•å¼€çŠ¶æ€ï¼‰
            const currentExpanded = document.querySelector('.task-content.expanded');
            if (currentExpanded) {
                const textarea = currentExpanded.querySelector('textarea');
                if (textarea) {
                    const match = textarea.id.match(/task-(\d+)/);
                    if (match) expandedTaskId = parseFloat(match[1]);
                }
            }

            // æŒ‰æ—¥æœŸåˆ†ç»„
            const byDate = {};
            plan.forEach(p => {
                if (!byDate[p.date]) byDate[p.date] = [];
                byDate[p.date].push(p);
            });

            const now = new Date();
            const today = getLocalDateString();
            const nowMinutes = now.getHours() * 60 + now.getMinutes();
            const nowSeconds = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

            // æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆç”¨äºè‡ªåŠ¨æ»šåŠ¨ï¼‰
            let nextTaskId = null;
            let foundNext = false;

            let html = '';
            Object.keys(byDate).sort().forEach(date => {
                html += `<h4 style="margin:16px 0 8px">ğŸ“… ${date}</h4>`;
                byDate[date].sort((a, b) => a.time.localeCompare(b.time)).forEach(task => {
                    const [h, m] = task.time.split(':').map(Number);
                    const taskMinutes = h * 60 + m;
                    const taskSeconds = h * 3600 + m * 60;

                    // åˆ¤æ–­ä»»åŠ¡çŠ¶æ€
                    let isExpired = task.done || (date < today) || (date === today && taskMinutes < nowMinutes);
                    let isCurrent = date === today && !task.done && taskMinutes === nowMinutes;
                    let isFuture = !isExpired && !isCurrent;

                    // æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œçš„ä»»åŠ¡
                    if (!foundNext && isFuture) {
                        nextTaskId = task.id;
                        foundNext = true;
                    }

                    // è®¡ç®—å€’è®¡æ—¶ï¼ˆä»…ä»Šå¤©æœªè¿‡æœŸçš„ä»»åŠ¡ï¼‰
                    let countdownText = '';
                    if (date === today && !task.done && taskSeconds > nowSeconds) {
                        const diffSeconds = taskSeconds - nowSeconds;
                        const remainHour = Math.floor(diffSeconds / 3600);
                        const remainMin = Math.floor((diffSeconds % 3600) / 60);
                        const remainSec = diffSeconds % 60;

                        if (diffSeconds < 3600) {
                            if (remainMin > 0) {
                                countdownText = `è¿˜æœ‰${remainMin}åˆ†${remainSec}ç§’`;
                            } else {
                                countdownText = `è¿˜æœ‰${remainSec}ç§’`;
                            }
                        } else {
                            countdownText = `è¿˜æœ‰${remainHour}å°æ—¶${remainMin}åˆ†`;
                        }
                    }

                    // æ ·å¼ç±»
                    let itemStyle = '';
                    let headerStyle = '';
                    let taskClass = 'task-item';

                    if (isExpired) {
                        // å·²è¿‡æœŸ - ç°è‰²
                        itemStyle = 'opacity:0.5; background:#f5f5f5;';
                        headerStyle = 'background:#e0e0e0;';
                    } else if (isCurrent) {
                        // å½“å‰æ‰§è¡Œä¸­ - é«˜äº®è“è‰²
                        taskClass = 'task-item current-task';
                        headerStyle = 'background:#e3f2fd;';
                    } else if (task.id === nextTaskId) {
                        // ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œ - é«˜äº®ç»¿è‰²
                        taskClass = 'task-item next-task';
                        headerStyle = 'background:#e8f5e9;';
                    }

                    const statusClass = task.done ? 'status-done' : 'status-pending';
                    const statusText = task.done ? 'å·²æ‰§è¡Œ' : (isExpired ? 'å·²è¿‡æœŸ' : 'å¾…æ‰§è¡Œ');

                    // ä»»åŠ¡é¡¹IDç”¨äºè‡ªåŠ¨æ»šåŠ¨ï¼ˆä»…ä¸‹ä¸€ä¸ªä»»åŠ¡éœ€è¦IDï¼‰
                    const taskIdAttr = task.id === nextTaskId ? `id="nextTask"` : '';
                    // ä¿æŒå±•å¼€çŠ¶æ€
                    const expandedClass = task.id === expandedTaskId ? 'expanded' : '';

                    html += `<div class="${taskClass}" ${taskIdAttr} style="${itemStyle}">
                        <div class="task-header" onclick="toggleTask(this)" style="${headerStyle}">
                            <span>
                                <strong>${task.time}</strong> - ${taskTypeNames[task.type]} - ${task.exam_display || (task.exam_grade + task.exam_subject)}
                                <span id="countdown-${task.id}" style="color:#1976D2; margin-left:8px; font-size:12px;">${countdownText ? 'â±ï¸ ' + countdownText : ''}</span>
                            </span>
                            <div style="display:flex;align-items:center;gap:8px">
                                <button class="btn btn-success" style="padding:4px 12px;font-size:12px;margin:0" onclick="event.stopPropagation();playTaskDirect(${task.id})" title="ç«‹å³æ’­æŠ¥">â–¶ æ’­æ”¾</button>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div class="task-content ${expandedClass}">
                            <label>æ’­æŠ¥å†…å®¹:</label>
                            <textarea id="task-${task.id}" rows="4">${task.content}</textarea>
                            <div style="margin-top:12px">
                                <button class="btn btn-success" onclick="playTask(${task.id})">â–¶ ç«‹å³æ’­æŠ¥</button>
                                ${task.type !== 'temp' ? `<button class="btn btn-outline" onclick="resetTask(${task.id})">æ¢å¤é»˜è®¤</button>` : ''}
                                <button class="btn btn-danger" onclick="deleteTask(${task.id})">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>`;
                });
            });
            container.innerHTML = html;

            // åªåœ¨éœ€è¦æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼ˆé¦–æ¬¡è¿›å…¥é¡µé¢æ—¶ï¼‰
            if (shouldAutoScroll && nextTaskId && !hasAutoScrolled) {
                setTimeout(() => {
                    const nextTaskEl = document.getElementById('nextTask');
                    if (nextTaskEl) {
                        nextTaskEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        hasAutoScrolled = true;
                    }
                }, 100);
            }
        }

        function toggleTask(header) {
            const content = header.nextElementSibling;
            const isExpanded = content.classList.contains('expanded');

            // åˆ‡æ¢å±•å¼€çŠ¶æ€
            content.classList.toggle('expanded');

            // è®°å½•å±•å¼€çš„ä»»åŠ¡IDï¼ˆç”¨äºä¿æŒå±•å¼€çŠ¶æ€ï¼‰
            if (!isExpanded) {
                // å±•å¼€æ—¶ï¼Œè·å–ä»»åŠ¡ID
                const textarea = content.querySelector('textarea');
                if (textarea) {
                    const match = textarea.id.match(/task-(\d+)/);
                    if (match) expandedTaskId = parseFloat(match[1]);
                }
            } else {
                // æŠ˜å æ—¶ï¼Œæ¸…é™¤è®°å½•
                expandedTaskId = null;
            }
        }

        function playTask(id) {
            const task = plan.find(p => p.id === id);
            if (task) {
                const content = document.getElementById(`task-${id}`).value;
                speak(content);
                log('ç«‹å³æ’­æŠ¥: ' + (task.exam_display || (task.exam_grade + task.exam_subject)) + ' - ' + taskTypeNames[task.type]);
            }
        }

        // ç›´æ¥ä»ä»»åŠ¡æ•°æ®æ’­æ”¾ï¼ˆä¸ä¾èµ–textareaï¼‰
        function playTaskDirect(id) {
            const task = plan.find(p => p.id === id);
            if (task) {
                speak(task.content);
                log('ç«‹å³æ’­æŠ¥: ' + (task.exam_display || (task.exam_grade + task.exam_subject)) + ' - ' + taskTypeNames[task.type]);
            }
        }

        function resetTask(id) {
            const task = plan.find(p => p.id === id);
            if (task && confirm('ç¡®å®šæ¢å¤é»˜è®¤æ¨¡æ¿å—ï¼Ÿ')) {
                // ä½¿ç”¨åŸå§‹è€ƒè¯•æ•°æ®é‡æ–°ç”Ÿæˆ
                const examsList = task._exams || [{ grade: task.exam_grade, subject: task.exam_subject, start_time: task.time, end_time: task.time }];
                const fresh = createMergedTask(task.date, examsList, task.type, task.time);
                task.content = fresh.content;
                task.exam_grade = fresh.exam_grade;
                task.exam_subject = fresh.exam_subject;
                task.exam_display = fresh.exam_display;
                document.getElementById(`task-${id}`).value = task.content;
                saveData();
                renderPlanList();
            }
        }

        function deleteTask(id) {
            if (confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªå¹¿æ’­ä»»åŠ¡å—ï¼Ÿ')) {
                plan = plan.filter(p => p.id !== id);
                saveData();
                renderPlanList();
            }
        }

        function saveAll() {
            // ä¿å­˜æ‰€æœ‰ç¼–è¾‘è¿‡çš„å†…å®¹
            plan.forEach(task => {
                const textarea = document.getElementById(`task-${task.id}`);
                if (textarea) {
                    task.content = textarea.value;
                }
            });
            saveData();
            alert('å·²ä¿å­˜æ‰€æœ‰ä¿®æ”¹');
            log('ä¿å­˜æ‰€æœ‰ä¿®æ”¹');
        }

        // å¯¼å‡ºå¹¿æ’­è®¡åˆ’ä¸ºWordæ–‡æ¡£ï¼ˆHTMLæ ¼å¼ï¼‰
        function exportPlan() {
            if (plan.length === 0) {
                alert('æš‚æ— å¹¿æ’­è®¡åˆ’ï¼Œè¯·å…ˆç”Ÿæˆ');
                return;
            }

            // æŒ‰æ—¥æœŸåˆ†ç»„
            const byDate = {};
            plan.forEach(p => {
                if (!byDate[p.date]) byDate[p.date] = [];
                byDate[p.date].push(p);
            });

            // ç”Ÿæˆå¹´çº§å¹¿æ’­åŒºåŸŸä¿¡æ¯
            let gradeLocationHtml = '';
            const hasLocations = Object.values(gradeLocations).some(loc => loc && loc.trim() !== '');
            if (hasLocations) {
                gradeLocationHtml = `
    <div style="margin-bottom: 30px; padding: 15px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 5px;">
        <h3 style="margin-top: 0; margin-bottom: 10px; font-size: 16px;">ğŸ“ å¹´çº§å¹¿æ’­åŒºåŸŸ</h3>
        <table style="width: auto; margin-bottom: 0;">
            <tr>
                ${Object.keys(gradeLocations).map(grade => `<th style="background: #e0e0e0; padding: 8px 15px;">${grade}</th>`).join('')}
            </tr>
            <tr>
                ${Object.values(gradeLocations).map(loc => `<td style="padding: 8px 15px;">${loc || '-'}</td>`).join('')}
            </tr>
        </table>
    </div>
`;
            }

            // ç”ŸæˆHTMLå†…å®¹
            let html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¹¿æ’­è®¡åˆ’</title>
    <style>
        body { font-family: 'Microsoft YaHei', SimSun, sans-serif; margin: 40px; }
        h1 { text-align: center; font-size: 24px; margin-bottom: 30px; }
        h2 { font-size: 18px; margin-top: 30px; margin-bottom: 15px; color: #333; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #333; padding: 10px; text-align: left; font-size: 14px; }
        th { background-color: #f0f0f0; font-weight: bold; }
        .time { width: 80px; }
        .type { width: 100px; }
        .exam { width: 150px; }
    </style>
</head>
<body>
    <h1>è€ƒè¯•å¹¿æ’­è®¡åˆ’è¡¨</h1>
    ${gradeLocationHtml}
`;

            Object.keys(byDate).sort().forEach(date => {
                html += `    <h2>ğŸ“… ${date}</h2>\n    <table>\n`;
                html += `        <tr><th class="time">æ—¶é—´</th><th class="type">ç±»å‹</th><th class="exam">è€ƒè¯•</th><th>æ’­æŠ¥å†…å®¹</th></tr>\n`;

                byDate[date].sort((a, b) => a.time.localeCompare(b.time)).forEach(task => {
                    const typeName = taskTypeNames[task.type] || task.type;
                    const examInfo = task.exam_display || (task.exam_grade + task.exam_subject);
                    html += `        <tr><td>${task.time}</td><td>${typeName}</td><td>${examInfo}</td><td>${task.content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td></tr>\n`;
                });

                html += `    </table>\n`;
            });

            html += `</body>\n</html>`;

            // åˆ›å»ºBlobå¹¶ä¸‹è½½
            const blob = new Blob([html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'å¹¿æ’­è®¡åˆ’_' + new Date().toISOString().slice(0,10) + '.doc';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log('å¹¿æ’­è®¡åˆ’å·²å¯¼å‡º');
        }

        // ==================== è¯­éŸ³æ’­æŠ¥ ====================
        // è·å–ä¸­æ–‡ç”·å£°
        function getChineseMaleVoice() {
            const voices = window.speechSynthesis.getVoices();
            // å°è¯•æ‰¾åˆ°ä¸­æ–‡ç”·å£°
            const maleVoice = voices.find(v =>
                v.lang.includes('zh') &&
                (v.name.includes('ç”·') ||
                 v.name.includes('Male') ||
                 v.name.includes('Kangkang') ||
                 v.name.includes('Yaoyao') === false)
            );
            return maleVoice || voices.find(v => v.lang.includes('zh')) || null;
        }

        function speak(text) {
            if (!window.speechSynthesis) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æŠ¥');
                return;
            }

            // æ›¿æ¢å˜é‡
            const now = new Date();
            const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            const finalText = text.replace(/\{\{current_time\}\}/g, timeStr);

            // åœæ­¢å½“å‰æ’­æŠ¥
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(finalText);
            utterance.lang = 'zh-CN';
            utterance.rate = 0.9;
            utterance.pitch = 0.8; // é™ä½éŸ³è°ƒï¼Œæ›´æ¥è¿‘ç”·å£°

            // å°è¯•è®¾ç½®ç”·å£°
            const maleVoice = getChineseMaleVoice();
            if (maleVoice) {
                utterance.voice = maleVoice;
            }

            window.speechSynthesis.speak(utterance);
        }

        function testVoice() {
            speak('è¯­éŸ³æµ‹è¯•ï¼Œè€ƒè¯•å¹¿æ’­ç³»ç»Ÿå°±ç»ªã€‚');
            log('è¯­éŸ³æµ‹è¯•');
        }

        // ==================== ä¸´æ—¶å¹¿æ’­ ====================
        function addTempBroadcast() {
            document.getElementById('tempModal').classList.add('show');
            document.getElementById('tempDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('tempTime').value = new Date().toTimeString().slice(0,5);
        }

        function closeModal() {
            document.getElementById('tempModal').classList.remove('show');
        }

        function playTempNow() {
            const content = document.getElementById('tempContent').value;
            if (content) {
                speak(content);
                closeModal();
            }
        }

        function addTempToPlan() {
            const date = document.getElementById('tempDate').value;
            const time = document.getElementById('tempTime').value;
            const content = document.getElementById('tempContent').value;

            if (!date || !time || !content) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }

            plan.push({
                id: Date.now(),
                date,
                time,
                type: 'temp',
                exam_grade: '',
                exam_subject: 'ä¸´æ—¶',
                content,
                done: false
            });

            plan.sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));
            saveData();
            renderPlanList();
            closeModal();
            log('æ·»åŠ ä¸´æ—¶å¹¿æ’­: ' + date + ' ' + time);
        }

        // ==================== è¿è¡Œæ§åˆ¶ ====================
        // è‡ªåŠ¨å¯åŠ¨è¿è¡Œ
        function autoStartRun() {
            isRunning = true;
            if (!checkInterval) {
                checkInterval = setInterval(checkTasks, 1000);
            }
            updatePlanRunUI();
            log('ç³»ç»Ÿå·²è‡ªåŠ¨å¯åŠ¨è¿è¡Œ');
        }

        // æš‚åœè‡ªåŠ¨è¿è¡Œï¼ˆç”¨äºå¹¿æ’­è®¡åˆ’é¡µé¢ï¼‰
        function pauseAutoRun() {
            isRunning = false;
            updatePlanRunUI();
            log('ç³»ç»Ÿå·²æš‚åœ');
        }

        // æ¢å¤è‡ªåŠ¨è¿è¡Œï¼ˆç”¨äºå¹¿æ’­è®¡åˆ’é¡µé¢ï¼‰
        function resumeAutoRun() {
            isRunning = true;
            if (!checkInterval) {
                checkInterval = setInterval(checkTasks, 1000);
            }
            updatePlanRunUI();
            log('ç³»ç»Ÿå·²æ¢å¤');
        }

        // æ›´æ–°å¹¿æ’­è®¡åˆ’é¡µé¢çš„è¿è¡ŒçŠ¶æ€UI
        function updatePlanRunUI() {
            const statusEl = document.getElementById('planRunStatus');
            const pauseBtn = document.getElementById('btnPlanPause');
            const resumeBtn = document.getElementById('btnPlanResume');

            if (statusEl) {
                statusEl.innerHTML = isRunning
                    ? '<span style="color:#4CAF50; font-weight:bold">ğŸŸ¢ è¿è¡Œä¸­</span>'
                    : '<span style="color:#FF9800; font-weight:bold">ğŸŸ¡ å·²æš‚åœ</span>';
            }
            if (pauseBtn) pauseBtn.classList.toggle('hidden', !isRunning);
            if (resumeBtn) resumeBtn.classList.toggle('hidden', isRunning);
        }

        // å…¼å®¹æ—§ä»£ç çš„å‡½æ•°ï¼ˆä¿ç•™ä½†ç®€åŒ–ï¼‰
        function startRun() {
            autoStartRun();
        }

        function pauseRun() {
            pauseAutoRun();
        }

        function resumeRun() {
            resumeAutoRun();
        }

        function stopRun() {
            isRunning = false;
            if (checkInterval) {
                clearInterval(checkInterval);
                checkInterval = null;
            }
            updatePlanRunUI();
            log('ç³»ç»Ÿå·²åœæ­¢');
        }

        function updateRunUI() {
            // å…¼å®¹æ—§ä»£ç ï¼Œå®é™…ä½¿ç”¨ updatePlanRunUI
            updatePlanRunUI();
        }

        function checkTasks() {
            if (!isRunning) return;

            const now = new Date();
            const dateStr = getLocalDateString(now);
            const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:00`;

            plan.forEach(task => {
                if (!task.done && task.date === dateStr && task.time + ':00' === timeStr) {
                    task.done = true;
                    speak(task.content);
                    saveData();
                    log(`è‡ªåŠ¨æ’­æŠ¥: ${task.exam_display || (task.exam_grade + task.exam_subject)} - ${taskTypeNames[task.type]}`);
                    renderTodayTasks();
                    // å®æ—¶æ›´æ–°å¹¿æ’­è®¡åˆ’åˆ—è¡¨çŠ¶æ€
                    renderPlanList(false);
                }
            });
        }

        // è·å–æœ¬åœ°æ—¥æœŸå­—ç¬¦ä¸² YYYY-MM-DD
        function getLocalDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // åªæ›´æ–°å¹¿æ’­è®¡åˆ’ä¸­çš„å€’è®¡æ—¶æ–‡æœ¬ï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨ï¼Œé¿å…æŠ˜å ï¼‰
        function updatePlanCountdown() {
            const now = new Date();
            const today = getLocalDateString();
            const nowSeconds = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

            // æ‰¾åˆ°æ‰€æœ‰å€’è®¡æ—¶å…ƒç´ å¹¶æ›´æ–°
            plan.forEach(task => {
                const countdownEl = document.getElementById(`countdown-${task.id}`);
                if (!countdownEl) return;

                const [h, m] = task.time.split(':').map(Number);
                const taskSeconds = h * 3600 + m * 60;

                // è®¡ç®—å€’è®¡æ—¶ï¼ˆä»…ä»Šå¤©æœªè¿‡æœŸä¸”æœªæ‰§è¡Œçš„ä»»åŠ¡ï¼‰
                if (task.date === today && !task.done && taskSeconds > nowSeconds) {
                    const diffSeconds = taskSeconds - nowSeconds;
                    const remainHour = Math.floor(diffSeconds / 3600);
                    const remainMin = Math.floor((diffSeconds % 3600) / 60);
                    const remainSec = diffSeconds % 60;

                    let countdownText = '';
                    if (diffSeconds < 3600) {
                        if (remainMin > 0) {
                            countdownText = `è¿˜æœ‰${remainMin}åˆ†${remainSec}ç§’`;
                        } else {
                            countdownText = `è¿˜æœ‰${remainSec}ç§’`;
                        }
                    } else {
                        countdownText = `è¿˜æœ‰${remainHour}å°æ—¶${remainMin}åˆ†`;
                    }
                    countdownEl.textContent = countdownText;
                } else {
                    // å·²è¿‡æœŸæˆ–å·²æ‰§è¡Œï¼Œæ¸…ç©ºå€’è®¡æ—¶
                    countdownEl.textContent = '';
                }
            });
        }

        function renderTodayTasks() {
            const container = document.getElementById('todayTasks');
            const dateDisplay = document.getElementById('todayDate');
            const today = getLocalDateString();

            // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
            if (dateDisplay) {
                dateDisplay.textContent = today;
            }

            const todayPlan = plan.filter(p => p.date === today).sort((a, b) => a.time.localeCompare(b.time));

            if (todayPlan.length === 0) {
                container.innerHTML = '<p style="color:#999">ä»Šæ—¥æ— è€ƒè¯•å®‰æ’</p>';
                return;
            }

            let html = '';
            todayPlan.forEach(task => {
                let icon = 'â³';
                let statusClass = 'status-pending';

                if (task.done) {
                    icon = 'âœ…';
                    statusClass = 'status-done';
                }

                const now = new Date();
                const [h, m] = task.time.split(':').map(Number);
                const taskTime = h * 60 + m;
                const nowTime = now.getHours() * 60 + now.getMinutes();
                const diff = taskTime - nowTime;

                let timeInfo = task.time;
                if (!task.done && diff > 0) {
                    // è®¡ç®—å‰©ä½™åˆ†é’Ÿå’Œç§’æ•°
                    const nowSeconds = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
                    const taskSeconds = h * 3600 + m * 60;
                    const diffSeconds = taskSeconds - nowSeconds;

                    if (diffSeconds > 0 && diffSeconds < 3600) {
                        const remainMin = Math.floor(diffSeconds / 60);
                        const remainSec = diffSeconds % 60;
                        if (remainMin > 0) {
                            timeInfo += ` (è¿˜æœ‰${remainMin}åˆ†${remainSec}ç§’)`;
                        } else {
                            timeInfo += ` (è¿˜æœ‰${remainSec}ç§’)`;
                        }
                    } else if (diffSeconds >= 3600) {
                        const remainHour = Math.floor(diffSeconds / 3600);
                        const remainMin = Math.floor((diffSeconds % 3600) / 60);
                        timeInfo += ` (è¿˜æœ‰${remainHour}å°æ—¶${remainMin}åˆ†)`;
                    }
                }

                html += `<div style="padding:8px 0; border-bottom:1px solid #eee">
                    <span class="status-badge ${statusClass}">${icon}</span>
                    <span style="margin-left:8px">${timeInfo} - ${taskTypeNames[task.type]} - ${task.exam_display || (task.exam_grade + task.exam_subject)}</span>
                </div>`;
            });
            container.innerHTML = html;
        }

        // ==================== åˆå§‹åŒ– ====================
        window.onload = function() {
            log('ç³»ç»Ÿå°±ç»ª');

            // é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
            if (window.speechSynthesis) {
                window.speechSynthesis.getVoices();
                // è¯­éŸ³åˆ—è¡¨å¯èƒ½æ˜¯å¼‚æ­¥åŠ è½½çš„ï¼Œç›‘å¬å˜åŒ–
                window.speechSynthesis.onvoiceschanged = function() {
                    window.speechSynthesis.getVoices();
                };
            }

            // å¯åŠ¨å³ä¸Šè§’æ—¶é—´æ˜¾ç¤ºï¼ˆæ¯ç§’æ›´æ–°ï¼‰
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // å°è¯•ä» LocalStorage åŠ è½½æ•°æ®
            const hasData = loadFromLocalStorage();

            if (hasData && exams.length > 0) {
                log('å·²è‡ªåŠ¨åŠ è½½ ' + exams.length + ' åœºè€ƒè¯•, ' + plan.length + ' ä¸ªå¹¿æ’­ä»»åŠ¡');
                // åˆ·æ–°æ˜¾ç¤º
                renderExamList();
                renderPlanList();
            }

            // åŠ è½½å¹´çº§å¹¿æ’­åŒºåŸŸè®¾ç½®åˆ°ä¾§è¾¹æ 
            loadGradeLocations();

            // è‡ªåŠ¨å¯åŠ¨è¿è¡Œ
            autoStartRun();

            // æ¢å¤ä¹‹å‰ä¿å­˜çš„tabï¼ˆè¿è¡Œæ§åˆ¶å·²ç§»é™¤ï¼‰
            const savedTab = localStorage.getItem('examBroadcastCurrentTab');
            if (savedTab && ['import', 'schedule', 'plan', 'settings'].includes(savedTab)) {
                showSection(savedTab);
            }
        };

        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.onbeforeunload = function() {
            saveAll();
        };
    </script>
</body>
</html>
